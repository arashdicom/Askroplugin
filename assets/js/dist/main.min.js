!function(e){"use strict";window.AskMe=window.AskMe||{},AskMe.config={ajaxUrl:askroAjax.ajax_url,nonce:askroAjax.nonce,userId:askroAjax.user_id||0,isLoggedIn:askroAjax.is_logged_in||!1,strings:{loading:"جاري التحميل...",error:"حدث خطأ، يرجى المحاولة مرة أخرى",success:"تم بنجاح",confirm:"هل أنت متأكد؟",voteSuccess:"تم التصويت بنجاح",voteError:"فشل في التصويت",commentSuccess:"تم إضافة التعليق بنجاح",commentError:"فشل في إضافة التعليق",bestAnswerSuccess:"تم تحديد أفضل إجابة بنجاح",bestAnswerError:"فشل في تحديد أفضل إجابة"}},AskMe.utils={showNotification:function(t,n="info"){const s=e(`\n                <div class="askme-notification askme-notification-${n}">\n                    <div class="askme-notification-content">\n                        <span class="askme-notification-message">${t}</span>\n                        <button class="askme-notification-close">&times;</button>\n                    </div>\n                </div>\n            `);e("body").append(s),setTimeout(()=>{s.fadeOut(()=>s.remove())},5e3),s.find(".askme-notification-close").on("click",function(){s.fadeOut(()=>s.remove())})},debounce:function(e,t){let n;return function(...s){clearTimeout(n),n=setTimeout(()=>{clearTimeout(n),e(...s)},t)}},formatNumber:function(e){return e>=1e6?(e/1e6).toFixed(1)+"M":e>=1e3?(e/1e3).toFixed(1)+"K":e.toString()},timeAgo:function(e){const t=new Date,n=new Date(e),s=Math.floor((t-n)/1e3);if(s<60)return"الآن";const o=Math.floor(s/60);if(o<60)return`منذ ${o} دقيقة`;const a=Math.floor(o/60);if(a<24)return`منذ ${a} ساعة`;const i=Math.floor(a/24);if(i<7)return`منذ ${i} يوم`;const c=Math.floor(i/7);if(c<4)return`منذ ${c} أسبوع`;const r=Math.floor(i/30);return r<12?`منذ ${r} شهر`:`منذ ${Math.floor(i/365)} سنة`}},AskMe.ajax={request:function(t,n={}){const s={action:t,nonce:AskMe.config.nonce,...n};return e.ajax({url:AskMe.config.ajaxUrl,type:"POST",data:s,dataType:"json"})},handleResponse:function(e,t,n){if(e.success)t&&t(e.data),e.data.message&&AskMe.utils.showNotification(e.data.message,"success");else{n&&n(e.data);const t=e.data.message||AskMe.config.strings.error;AskMe.utils.showNotification(t,"error")}}},AskMe.voting={init:function(){this.bindEvents()},bindEvents:function(){e(document).on("click",".askme-vote-btn",function(t){t.preventDefault(),AskMe.voting.handleVote(e(this))})},handleVote:function(e){if(!AskMe.config.isLoggedIn)return void AskMe.utils.showNotification("يجب تسجيل الدخول للتصويت","warning");const t=e.data("post-id"),n=e.data("vote-type"),s=e.closest(".askme-voting-section").find(".askme-score-value");e.addClass("loading");const o=e.html();e.html('<span class="askme-loading-spinner"></span>'),AskMe.ajax.request("askro_vote",{post_id:t,vote_type:n}).then(function(t){AskMe.ajax.handleResponse(t,function(t){s.length&&s.text(AskMe.utils.formatNumber(t.new_score)),e.toggleClass("active",t.user_vote===n),e.siblings(".askme-vote-btn").removeClass("active"),AskMe.utils.showNotification(AskMe.config.strings.voteSuccess,"success")})}).fail(function(){AskMe.utils.showNotification(AskMe.config.strings.voteError,"error")}).always(function(){e.removeClass("loading").html(o)})}},AskMe.comments={init:function(){this.bindEvents()},bindEvents:function(){e(document).on("click",".askme-view-comments-btn",function(t){t.preventDefault(),AskMe.comments.toggleComments(e(this))}),e(document).on("submit",".askro-comment-form",function(t){t.preventDefault(),AskMe.comments.submitComment(e(this))}),e(document).on("submit",".askme-comment-form",function(t){t.preventDefault(),AskMe.comments.submitComment(e(this))}),e(document).on("click",".askme-comment-reaction",function(t){t.preventDefault(),AskMe.comments.handleReaction(e(this))}),e(document).on("click",".askme-comment-edit",function(t){t.preventDefault(),AskMe.comments.editComment(e(this))}),e(document).on("click",".askme-comment-delete",function(t){t.preventDefault(),AskMe.comments.deleteComment(e(this))})},toggleComments:function(t){const n=t.data("answer-id"),s=e(`.askme-comments-section[data-answer-id="${n}"]`);s.is(":visible")?(s.slideUp(),t.text("عرض التعليقات")):(0===s.find(".askme-comments-list").children().length&&this.loadComments(n,s),s.slideDown(),t.text("إخفاء التعليقات"))},loadComments:function(t,n){if(!t||!n.length)return console.log("🔥 DEBUG: Invalid input for loadComments:",{answerId:t,containerExists:n.length}),void AskMe.utils.showNotification("بيانات غير صحيحة لتحميل التعليقات","error");const s=e('<div class="askme-loading">جاري تحميل التعليقات...</div>');n.find(".askme-comments-list").append(s);const o=n.find(".askme-comment-form").find('input[name="nonce"]').val();if(!o)return console.log("🔥 DEBUG: No nonce found for loadComments"),s.remove(),void AskMe.utils.showNotification("خطأ في التحقق من الأمان","error");AskMe.ajax.request("askro_load_comments",{answer_id:t,nonce:o}).then(function(e){AskMe.ajax.handleResponse(e,function(e){s.remove(),e.comments_html&&n.find(".askme-comments-list").html(e.comments_html)})}).fail(function(e,t,o){s.remove(),console.log("🔥 DEBUG: Failed to load comments:",e,t,o);let a="فشل في تحميل التعليقات";e.responseJSON&&e.responseJSON.data&&e.responseJSON.data.message&&(a=e.responseJSON.data.message),n.find(".askme-comments-list").html(`<div class="askme-error">${a}</div>`),AskMe.utils.showNotification(a,"error")})},submitComment:function(t){if(console.log("🔥 DEBUG: Comment submission started"),console.log("🔥 DEBUG: Form element:",t),!t.length)return console.log("🔥 DEBUG: Form element not found"),void AskMe.utils.showNotification("عنصر النموذج غير موجود","error");const n=t.data("post-id"),s=t.data("parent-id")||0,o=t.find('textarea[name="comment_content"]').val().trim(),a=t.find('input[name="askro_comment_nonce"]').val();if(console.log("🔥 DEBUG: Post ID:",n),console.log("🔥 DEBUG: Parent ID:",s),console.log("🔥 DEBUG: Content length:",o.length),console.log("🔥 DEBUG: Nonce exists:",!!a),!n)return console.log("🔥 DEBUG: Post ID validation failed"),void AskMe.utils.showNotification("معرف المنشور غير صحيح","error");if(!o)return console.log("🔥 DEBUG: Content validation failed"),void AskMe.utils.showNotification("يرجى كتابة تعليق","warning");if(o.length<3)return console.log("🔥 DEBUG: Content too short"),void AskMe.utils.showNotification("التعليق يجب أن يحتوي على 3 أحرف على الأقل","warning");if(o.length>1e3)return console.log("🔥 DEBUG: Content too long"),void AskMe.utils.showNotification("التعليق طويل جداً. الحد الأقصى 1000 حرف","warning");if(!a)return console.log("🔥 DEBUG: Nonce validation failed"),void AskMe.utils.showNotification("خطأ في التحقق من الأمان","error");const i=t.find(".askro-submit-comment-btn, .askme-submit-comment-btn"),c=i.text();i.prop("disabled",!0).text(AskMe.config.strings.loading),console.log("🔥 DEBUG: Submit button disabled, sending AJAX request"),AskMe.ajax.request("askro_add_comment",{post_id:n,parent_id:s,comment_content:o,askro_comment_nonce:a}).then(function(s){console.log("🔥 DEBUG: AJAX response received:",s),AskMe.ajax.handleResponse(s,function(s){console.log("🔥 DEBUG: Success callback data:",s);const o=t.closest(".askme-comments-section").find(".askme-comments-list");console.log("🔥 DEBUG: Comments list element:",o),o.append(s.comment_html||s.html),t.find("textarea").val(""),console.log("🔥 DEBUG: Form cleared");const a=e(`.askme-view-comments-btn[data-post-id="${n}"]`);if(a.length){const e=a.text(),t=e.match(/\((\d+)\)/);if(t){const n=parseInt(t[1])+1;a.text(e.replace(/\(\d+\)/,`(${n})`)),console.log("🔥 DEBUG: Comment count updated to:",n)}}})}).fail(function(e,t,n){console.log("🔥 DEBUG: AJAX request failed:",e,t,n);let s=AskMe.config.strings.commentError;e.responseJSON&&e.responseJSON.data&&e.responseJSON.data.message&&(s=e.responseJSON.data.message),AskMe.utils.showNotification(s,"error")}).always(function(){console.log("🔥 DEBUG: AJAX request completed, re-enabling button"),i.prop("disabled",!1).text(c)})},handleReaction:function(e){if(!AskMe.config.isLoggedIn)return void AskMe.utils.showNotification("يجب تسجيل الدخول للتفاعل","warning");const t=e.data("comment-id"),n=e.data("reaction"),s=e.find(".askme-reaction-count");AskMe.ajax.request("askro_comment_reaction",{comment_id:t,reaction:n}).then(function(e){AskMe.ajax.handleResponse(e,function(e){s.text(e.new_count)})})},editComment:function(t){const n=t.closest(".askme-comment"),s=n.find(".askme-comment-content"),o=s.text().trim(),a=e(`\n                <div class="askme-comment-edit-form">\n                    <textarea class="askme-comment-edit-textarea">${o}</textarea>\n                    <div class="askme-comment-edit-actions">\n                        <button class="askme-comment-save-btn">حفظ</button>\n                        <button class="askme-comment-cancel-btn">إلغاء</button>\n                    </div>\n                </div>\n            `);s.hide(),s.after(a),a.find(".askme-comment-save-btn").on("click",function(){const e=a.find("textarea").val().trim();e&&AskMe.comments.saveComment(n,e)}),a.find(".askme-comment-cancel-btn").on("click",function(){a.remove(),s.show()})},saveComment:function(e,t){const n=e.data("comment-id");AskMe.ajax.request("askro_edit_comment",{comment_id:n,content:t}).then(function(n){AskMe.ajax.handleResponse(n,function(n){e.find(".askme-comment-content").text(t).show(),e.find(".askme-comment-edit-form").remove()})})},deleteComment:function(e){if(!confirm(AskMe.config.strings.confirm))return;const t=e.closest(".askme-comment"),n=t.data("comment-id");AskMe.ajax.request("askro_delete_comment",{comment_id:n}).then(function(e){AskMe.ajax.handleResponse(e,function(e){t.fadeOut(()=>t.remove())})})}},AskMe.bestAnswer={init:function(){this.bindEvents()},bindEvents:function(){e(document).on("click",".askme-best-answer-btn",function(t){t.preventDefault(),AskMe.bestAnswer.markBestAnswer(e(this))})},markBestAnswer:function(t){if(!confirm(AskMe.config.strings.confirm))return;const n=t.data("answer-id"),s=t.closest(".askme-answer");t.prop("disabled",!0).text(AskMe.config.strings.loading),AskMe.ajax.request("askro_mark_best_answer",{answer_id:n}).then(function(n){AskMe.ajax.handleResponse(n,function(n){const o=s.closest(".askme-answers-section").find(".askme-best-answer");if(o.length)o.find(".askme-best-answer-content").html(s.detach());else{const t=e('\n                            <div class="askme-best-answer">\n                                <div class="askme-best-answer-header">\n                                    <span class="askme-best-answer-badge">👑 أفضل إجابة</span>\n                                </div>\n                                <div class="askme-best-answer-content"></div>\n                            </div>\n                        ');t.find(".askme-best-answer-content").append(s.detach()),s.closest(".askme-answers-section").prepend(t)}t.remove(),AskMe.utils.showNotification(AskMe.config.strings.bestAnswerSuccess,"success")})}).fail(function(){AskMe.utils.showNotification(AskMe.config.strings.bestAnswerError,"error")}).always(function(){t.prop("disabled",!1).text("أفضل إجابة")})}},AskMe.questionStatus={init:function(){this.bindEvents()},bindEvents:function(){e(document).on("change",".askme-status-select",function(){AskMe.questionStatus.updateStatus(e(this))})},updateStatus:function(e){const t=e.data("question-id"),n=e.val();e.prop("disabled",!0),AskMe.ajax.request("askro_update_question_status",{question_id:t,status:n}).then(function(t){AskMe.ajax.handleResponse(t,function(t){const s=e.closest(".askme-question-header").find(".askme-status-badge");s.length&&s.removeClass().addClass(`askme-status-badge askme-status-${n}`).text(t.status_label)})}).fail(function(){AskMe.utils.showNotification("فشل في تحديث حالة السؤال","error")}).always(function(){e.prop("disabled",!1)})}},AskMe.initFormValidation=function(){e(".askme-form").on("submit",function(t){const n=e(this);let s=!0;n.find(".askme-form-error").remove(),n.find(".askme-input-error").removeClass("askme-input-error"),n.find("[required]").each(function(){const t=e(this);if(!t.val().trim()){s=!1,t.addClass("askme-input-error");const e=t.data("error-message")||"هذا الحقل مطلوب";t.after(`<div class="askme-form-error">${e}</div>`)}}),n.find('input[type="email"]').each(function(){const t=e(this),n=t.val().trim();n&&!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(n)&&(s=!1,t.addClass("askme-input-error"),t.after('<div class="askme-form-error">يرجى إدخال بريد إلكتروني صحيح</div>'))}),s||(t.preventDefault(),AskMe.utils.showNotification("يرجى تصحيح الأخطاء في النموذج","error"))})},AskMe.search={init:function(){this.bindEvents()},bindEvents:function(){const t=e("#askro-search-input");t.length&&t.on("input",AskMe.utils.debounce(function(){AskMe.search.performSearch(e(this).val())},500))},performSearch:function(t){t.length<3?e("#askro-search-suggestions").empty().hide():AskMe.ajax.request("askro_search_questions",{query:t}).then(function(t){AskMe.ajax.handleResponse(t,function(t){if(t.results&&t.results.length>0){const n=t.results.map(function(e){return`\n                                <div class="askme-search-suggestion">\n                                    <a href="${e.url}" class="askme-suggestion-link">\n                                        <div class="askme-suggestion-title">${e.title}</div>\n                                        <div class="askme-suggestion-meta">\n                                            ${e.status?`<span class="askme-suggestion-status">${e.status}</span>`:""}\n                                            <span class="askme-suggestion-answers">${e.answers_count} إجابة</span>\n                                        </div>\n                                    </a>\n                                </div>\n                            `}).join("");e("#askro-search-suggestions").html(n).show()}else e("#askro-search-suggestions").html('<div class="askme-no-results">لا توجد نتائج</div>').show()})})}},AskMe.answerForm={init:function(){this.bindEvents()},bindEvents:function(){e(document).on("submit","#askro-answer-form",function(t){t.preventDefault(),AskMe.answerForm.handleSubmit(e(this))})},handleSubmit:function(t){const n=t.find('button[type="submit"]'),s=n.text();n.prop("disabled",!0).text("جاري الإرسال...");const o=new FormData(t[0]);o.append("action","askro_submit_answer"),e.ajax({url:AskMe.config.ajaxUrl,type:"POST",data:o,processData:!1,contentType:!1,success:function(e){e.success?(AskMe.utils.showNotification("تم إضافة الإجابة بنجاح!","success"),AskMe.answerForm.addAnswerToPage(e.data),t[0].reset(),"undefined"!=typeof tinyMCE&&tinyMCE.get("askro-answer-content")&&tinyMCE.get("askro-answer-content").setContent("")):AskMe.utils.showNotification(e.data||"حدث خطأ في إضافة الإجابة","error")},error:function(e,t,n){console.error("Answer submission error:",n),AskMe.utils.showNotification("حدث خطأ في الاتصال","error")},complete:function(){n.prop("disabled",!1).text(s)}})},addAnswerToPage:function(t){const n=e(".askme-answers-list");if(!n.length)return;const s=this.createAnswerHTML(t);n.prepend(s);const o=e(".askme-answers-count");if(o.length){const e=parseInt(o.text())||0;o.text(e+1)}AskMe.voting.init(),AskMe.comments.init()},createAnswerHTML:function(e){const t=(AskMe.config.currentUser||{}).ID==e.author_id;return`\n                <div class="askme-answer-card" data-answer-id="${e.id}">\n                    <div class="askme-answer-content">\n                        <div class="askme-answer-header">\n                            <div class="askme-answer-author">\n                                <img src="${e.author_avatar}" alt="${e.author_name}" class="askme-avatar">\n                                <div class="askme-author-info">\n                                    <span class="askme-author-name">${e.author_name}</span>\n                                    <span class="askme-author-rank">${e.author_rank}</span>\n                                </div>\n                            </div>\n                            <div class="askme-answer-meta">\n                                <span class="askme-answer-date" data-timestamp="${e.date}">الآن</span>\n                            </div>\n                        </div>\n                        <div class="askme-answer-body">\n                            ${e.content}\n                        </div>\n                        <div class="askme-answer-actions">\n                            <div class="askme-voting-buttons" data-post-id="${e.id}" data-post-type="answer">\n                                <button class="askme-vote-btn askme-vote-up" data-vote-type="useful" title="مفيد">\n                                    <span class="askme-vote-icon">✔️</span>\n                                    <span class="askme-vote-count">0</span>\n                                </button>\n                                <button class="askme-vote-btn askme-vote-down" data-vote-type="incorrect" title="غير صحيح">\n                                    <span class="askme-vote-icon">❌</span>\n                                    <span class="askme-vote-count">0</span>\n                                </button>\n                            </div>\n                            ${t?"":'<button class="askme-mark-best-btn" data-answer-id="'+e.id+'">تحديد كأفضل إجابة</button>'}\n                        </div>\n                    </div>\n                </div>\n            `}},e(document).ready(function(){AskMe.voting.init(),AskMe.comments.init(),AskMe.bestAnswer.init(),AskMe.questionStatus.init(),AskMe.search.init(),AskMe.answerForm.init(),AskMe.initFormValidation(),e(".askme-question-time, .askme-comment-date").each(function(){const t=e(this),n=t.data("timestamp")||t.attr("datetime");n&&t.text(AskMe.utils.timeAgo(n))}),e(".askme-stat-value, .askme-score-value").each(function(){const t=e(this),n=parseInt(t.text());isNaN(n)||t.text(AskMe.utils.formatNumber(n))})})}(jQuery);
